name: DNS Blocklist Updater
on:
  schedule:
    - cron: '30 6,11 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Blocklist
      run: |
        # Create array of URLs to fetch
        urls=(
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/hosts/ultimate-compressed.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/popupads.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/hoster.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adguard/dns-rebind-protection.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/social.txt"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/analyticsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/doubleclickparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/dnsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/proxiesparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/shortlinksparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fontsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/productsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/androidparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fiberparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/firebaseparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/generalparsed"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/native.oppo-realme.txt"
          "https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/microsoft/all"
        )
        
        # Create header
        echo "# DNS Blocklist - Auto-generated" > blocklist.txt
        echo "# Last Updated: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" >> blocklist.txt
        echo "# Sources: hagezi, nickspaargaren, jmdugan" >> blocklist.txt
        echo "# ==============================================" >> blocklist.txt
        
        # Download all files and keep original format
        for url in "${urls[@]}"; do
          echo "Processing: $url" >&2
          curl -s "$url"
        done | \
        # Sort and remove duplicates
        sort -u | \
        # Remove Facebook domains
        grep -v -E '^.*facebook\.com$' | \
        grep -v -E '^.*\.fb\.com$' | \
        grep -v -E '^.*\.facebook\.com$' | \
        grep -v -E '^.*\.blogspot\.com$' | \
        grep -v -E '^blogspot\.com$' | \
        grep -v -E '^fb\.com$' | \
        grep -v -E '^facebook\.com$' >> blocklist.txt
        
        # Add manual domains section at the end
        echo "" >> blocklist.txt
        echo "# === MANUAL HEYTAP DOMAINS ===" >> blocklist.txt
        echo "storeimg.heytapimg.com" >> blocklist.txt
        echo "time-push-in.heytapmobile.com" >> blocklist.txt
        echo "httpdns-push.heytapmobile.com" >> blocklist.txt
        echo "client-uc.heytapmobi.com" >> blocklist.txt
        echo "app-measurement.com" >> blocklist.txt
        
        echo "" >> blocklist.txt
        echo "# === MTALK.GOOGLE.COM DOMAINS ===" >> blocklist.txt
        echo "*.mtalk.google.com" >> blocklist.txt
        echo "alt1-mtalk.google.com" >> blocklist.txt
        echo "alt2-mtalk.google.com" >> blocklist.txt
        echo "alt3-mtalk.google.com" >> blocklist.txt
        echo "alt4-mtalk.google.com" >> blocklist.txt
        echo "alt5-mtalk.google.com" >> blocklist.txt
        echo "alt6-mtalk.google.com" >> blocklist.txt
        echo "alt7-mtalk.google.com" >> blocklist.txt
        echo "alt8-mtalk.google.com" >> blocklist.txt
        echo "mtalk.google.com" >> blocklist.txt
        
        echo "" >> blocklist.txt
        echo "# === WILDCARD HEYTAP DOMAINS ===" >> blocklist.txt
        echo "*.heytapimg.com" >> blocklist.txt
        echo "*.heytapmobile.com" >> blocklist.txt
        echo "*.heytapmobi.com" >> blocklist.txt
        echo "*.heytap.com" >> blocklist.txt
        echo "*.heytapdl.com" >> blocklist.txt
        echo "*.heytapdownload.com" >> blocklist.txt
        echo "*.app-measurement.com" >> blocklist.txt
        echo "*app-measurement.com" >> blocklist.txt
        
        echo "âœ… Created blocklist.txt"
        echo "Total entries: $(grep -v '^#' blocklist.txt | grep -v '^=' | wc -l)"
        
    - name: Commit Changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add blocklist.txt
        git commit -m "Update blocklist: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST') - $(grep -v '^#' blocklist.txt | grep -v '^=' | wc -l) entries" || echo "No changes"
        git push
