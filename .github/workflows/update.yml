name: DNS Blocklist Updater
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Blocklist
      run: |
        # Download and combine ALL lists
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt" > combined.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt" >> combined.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/ultimate.txt" >> combined.txt
        curl -s "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt" >> combined.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt" >> combined.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adguard/dns-rebind-protection.txt" >> combined.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/social.txt" >> combined.txt
        
        # Clean up: keep only domains (removed comment cleaning)
        sed 's/^||//; s/\^.*$//; s/^0\.0\.0\.0 //; s/^127\.0\.0\.1 //' combined.txt | \
        sort -u > blocklist.txt
        
        # Count and show
        COUNT=$(wc -l < blocklist.txt)
        echo "âœ… Created blocklist.txt with $COUNT domains"
        
    - name: Commit Changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add blocklist.txt
        git commit -m "Update: $(date)" || echo "No changes"
        git push
