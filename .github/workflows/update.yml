name: DNS Blocklist Updater
on:
  schedule:
    - cron: '30 3 * * *'  # 03:30 UTC = 9:00 AM IST
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Hosts File Blocklist
      run: |
        # Create fresh hosts file
        echo "# Hosts file for blocking domains" > hosts-blocklist.txt
        echo "# Generated: $(date)" >> hosts-blocklist.txt
        echo "# Redirects to 0.0.0.1 (nowhere)" >> hosts-blocklist.txt
        echo "" >> hosts-blocklist.txt
        
        # Create temporary files
        > temp-domains.txt
        
        # === DOWNLOAD ALL LISTS AND EXTRACT DOMAINS ===
        
        # 1. hagezi lists
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/ultimate.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adguard/dns-rebind-protection.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/social.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        
        # 2. Google blocklists
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/analyticsparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/doubleclickparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/dnsparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/proxiesparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/shortlinksparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fontsparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/productsparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/androidparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fiberparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/firebaseparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/generalparsed" >> temp-domains.txt
        echo "" >> temp-domains.txt
        
        # 3. Additional lists
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/native.oppo-realme.txt" >> temp-domains.txt
        echo "" >> temp-domains.txt
        curl -s "https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/microsoft/all" >> temp-domains.txt
        echo "" >> temp-domains.txt
        
        # 4. Manual Heytap domains
        echo "storeimg.heytapimg.com" >> temp-domains.txt
        echo "time-push-in.heytapmobile.com" >> temp-domains.txt
        echo "httpdns-push.heytapmobile.com" >> temp-domains.txt
        echo "client-uc.heytapmobi.com" >> temp-domains.txt
        echo "alt5-mtalk.google.com" >> temp-domains.txt
        
        # === CLEAN AND CONVERT TO HOSTS FORMAT ===
        echo "# Processing domains..." >> hosts-blocklist.txt
        
        # Extract domains, clean, sort, remove duplicates
        cat temp-domains.txt | \
        # Remove comments and empty lines
        grep -v '^!' | grep -v '^#' | grep -v '^$' | grep -v '^/' | grep -v '##' | \
        # Extract domains from various formats
        sed -e 's/^||//' -e 's/\^.*$//' -e 's/^0\.0\.0\.0 //' -e 's/^127\.0\.0\.1 //' -e 's/^:: //' | \
        # Remove trailing whitespace
        sed 's/[[:space:]]*$//' | \
        # Remove lines starting with [ or containing :
        grep -v '^\[' | grep -v ':' | \
        # Keep only valid domain characters
        grep -E '^[a-zA-Z0-9.*_-]+\.[a-zA-Z]{2,}' | \
        # Sort and remove duplicates
        sort -u | \
        # Convert to hosts format: 0.0.0.1 domain.com
        while read domain; do
          # Handle wildcards - create multiple entries
          if [[ "$domain" == *"*"* ]]; then
            # For wildcards, just use base domain
            base_domain=$(echo "$domain" | sed 's/^\*\.//')
            echo "0.0.0.1 $base_domain" >> hosts-blocklist.txt
          else
            echo "0.0.0.1 $domain" >> hosts-blocklist.txt
          fi
        done
        
        # Add Heytap wildcards manually
        echo "" >> hosts-blocklist.txt
        echo "# Heytap/Oppo/Realme wildcards" >> hosts-blocklist.txt
        echo "0.0.0.1 heytapimg.com" >> hosts-blocklist.txt
        echo "0.0.0.1 heytapmobile.com" >> hosts-blocklist.txt
        echo "0.0.0.1 heytapmobi.com" >> hosts-blocklist.txt
        echo "0.0.0.1 heytap.com" >> hosts-blocklist.txt
        
        # Add IPv6 support (optional)
        echo "" >> hosts-blocklist.txt
        echo "# IPv6 entries" >> hosts-blocklist.txt
        echo "::1 localhost" >> hosts-blocklist.txt
        
        echo "âœ… Created hosts-blocklist.txt in hosts file format"
        
    - name: Commit Changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add hosts-blocklist.txt
        git commit -m "Update hosts file: $(date)" || echo "No changes"
        git push
