name: DNS Blocklist Updater
on:
  schedule:
    - cron: '30 2,5,8,11,14,17,20,23 * * *'  # Every 3 hours in IST (2:30, 5:30, 8:30, 11:30, 14:30, 17:30, 20:30, 23:30 IST)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Blocklist
      run: |
        # Create fresh file with header
        echo "127.0.0.1	localhost" > blocklist.txt
        echo "127.0.1.1	home-desktop" >> blocklist.txt
        echo "" >> blocklist.txt
        echo "# The following lines are desirable for IPv6 capable hosts" >> blocklist.txt
        echo "::1     ip6-localhost ip6-loopback" >> blocklist.txt
        echo "fe00::0 ip6-localnet" >> blocklist.txt
        echo "ff00::0 ip6-mcastprefix" >> blocklist.txt
        echo "ff02::1 ip6-allnodes" >> blocklist.txt
        echo "ff02::2 ip6-allrouters" >> blocklist.txt
        echo "" >> blocklist.txt
        echo "# ==============================================" >> blocklist.txt
        echo "# DNS Blocklist - Auto-generated" >> blocklist.txt
        echo "# Last Updated: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" >> blocklist.txt
        echo "# ==============================================" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== doh-vpn-proxy-bypass.txt ===" >> blocklist.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== tif.txt ===" >> blocklist.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== ultimate.txt ===" >> blocklist.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/ultimate.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== spam-tlds.txt ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== dyndns.txt ===" >> blocklist.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== dns-rebind-protection.txt ===" >> blocklist.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adguard/dns-rebind-protection.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== social.txt ===" >> blocklist.txt
        curl -s "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/social.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        # === GOOGLE BLOCKLISTS ===
        echo "=== analyticsparsed (Google Analytics) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/analyticsparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== doubleclickparsed (Google Ads) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/doubleclickparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== dnsparsed (Google DNS) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/dnsparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== proxiesparsed (Google Proxies) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/proxiesparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== shortlinksparsed (goo.gl links) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/shortlinksparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== fontsparsed (Google Fonts) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fontsparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== productsparsed (Google Shopping) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/productsparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== androidparsed (Android/Play Store) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/androidparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== fiberparsed (Google Fiber) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fiberparsed" >> blocklist.txt
        echo "" >> blocklist.txt

        echo "=== Firebase (Google Firebase) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/firebaseparsed" >> blocklist.txt
        echo "" >> blocklist.txt

        echo "=== General (Google General) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/generalparsed" >> blocklist.txt
        echo "" >> blocklist.txt
        
        # === ADDITIONAL LISTS ===
        echo "=== native.oppo-realme.txt ===" >> blocklist.txt
        curl -s "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/native.oppo-realme.txt" >> blocklist.txt
        echo "" >> blocklist.txt
        
        echo "=== Microsoft All (corporate) ===" >> blocklist.txt
        curl -s "https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/microsoft/all" >> blocklist.txt
        echo "" >> blocklist.txt
        
        # === MANUAL HEYTAP DOMAINS ===
        echo "=== Manual Heytap/Oppo/Realme Domains ===" >> blocklist.txt
        echo "storeimg.heytapimg.com" >> blocklist.txt
        echo "time-push-in.heytapmobile.com" >> blocklist.txt
        echo "httpdns-push.heytapmobile.com" >> blocklist.txt
        echo "client-uc.heytapmobi.com" >> blocklist.txt
        # Block ALL -mtalk.google.com domains
        echo "*.mtalk.google.com" >> blocklist.txt
        echo "alt1-mtalk.google.com" >> blocklist.txt
        echo "alt2-mtalk.google.com" >> blocklist.txt
        echo "alt3-mtalk.google.com" >> blocklist.txt
        echo "alt4-mtalk.google.com" >> blocklist.txt
        echo "alt5-mtalk.google.com" >> blocklist.txt
        echo "alt6-mtalk.google.com" >> blocklist.txt
        echo "alt7-mtalk.google.com" >> blocklist.txt
        echo "alt8-mtalk.google.com" >> blocklist.txt
        echo "mtalk.google.com" >> blocklist.txt
        # Wildcard for all heytap domains
        echo "*.heytapimg.com" >> blocklist.txt
        echo "*.heytapmobile.com" >> blocklist.txt
        echo "*.heytapmobi.com" >> blocklist.txt
        echo "*.heytap.com" >> blocklist.txt
        
        # Update timestamp in header with IST
        sed -i "16s/.*/# Last Updated: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')/" blocklist.txt
        
        echo "âœ… Created blocklist.txt with header and all content in order"
        
    - name: Commit Changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add blocklist.txt
        git commit -m "Update: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" || echo "No changes"
        git push
