name: Update DNS Blocklist
on:
  schedule:
    - cron: '0 12 * * *'  # Daily at 12 PM UTC
  workflow_dispatch:       # Manual trigger button

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Merge all blocklists
      run: |
        echo "ğŸ” Downloading DNS blocklists..."
        
        # Download all 5 lists
        curl -s -L "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt" -o list1.txt
        curl -s -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt" -o list2.txt
        curl -s -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/ultimate.txt" -o list3.txt
        curl -s -L "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt" -o list4.txt
        curl -s -L "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt" -o list5.txt
        
        echo "âœ… Downloads complete"
        
        # Combine, clean, and sort
        echo "ğŸ§¹ Cleaning and merging..."
        cat list*.txt | \
          grep -v '^!' | \
          grep -v '^#' | \
          grep -v '^$' | \
          grep -v '^/' | \
          grep -v '##' | \
          sed 's/^||//; s/\^.*$//; s/^0\.0\.0\.0 //; s/^127\.0\.0\.1 //' | \
          sed '/^$/d' | \
          sort -u > all-domains.txt
        
        # Count domains
        DOMAIN_COUNT=$(wc -l < all-domains.txt)
        echo "ğŸ“Š Total unique domains: $DOMAIN_COUNT"
        
        # Create final file
        echo "ğŸ“ Creating blocklist.txt..."
        {
          echo "# Auto-updated DNS Blocklist"
          echo "# Generated: $(date -u)"
          echo "# Sources:"
          echo "# 1. doh-vpn-proxy-bypass.txt"
          echo "# 2. tif.txt"
          echo "# 3. ultimate.txt"
          echo "# 4. spam-tlds.txt"
          echo "# 5. dyndns.txt"
          echo "# Total domains: $DOMAIN_COUNT"
          echo ""
          cat all-domains.txt
        } > blocklist.txt
        
        # Also create hosts format
        {
          echo "# Hosts format - Auto-updated DNS Blocklist"
          echo "# Generated: $(date -u)"
          echo ""
          sed 's/^/0.0.0.0 /' all-domains.txt
        } > hosts-format.txt
        
        echo "âœ… Files created:"
        echo "   - blocklist.txt ($DOMAIN_COUNT domains)"
        echo "   - hosts-format.txt"
        
    - name: Commit and Push
      run: |
        echo "ğŸ“¤ Committing changes..."
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        
        # Check if there are changes
        if git diff --quiet; then
          echo "ğŸŸ¡ No changes detected"
        else
          git add blocklist.txt hosts-format.txt
          git commit -m "ğŸ¤– Auto-update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
          echo "âœ… Changes pushed successfully"
        fi
        
    - name: Show Summary
      run: |
        echo "=== UPDATE COMPLETE ==="
        echo "ğŸ“ Generated files:"
        echo "1. blocklist.txt (plain domains)"
        echo "2. hosts-format.txt (hosts file format)"
        echo ""
        echo "ğŸ“Š Sample from blocklist.txt:"
        echo "------------------------"
        head -5 blocklist.txt
        echo "..."
        tail -5 blocklist.txt
