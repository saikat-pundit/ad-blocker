name: DNS Blocklist Updater
on:
  schedule:
    - cron: '30 6,11 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Blocklist
      run: |
        # Create array of URLs to fetch
        urls=(
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/hosts/ultimate-compressed.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/popupads.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/hoster.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adguard/dns-rebind-protection.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/social.txt"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/analyticsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/doubleclickparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/dnsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/proxiesparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/shortlinksparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fontsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/productsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/androidparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fiberparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/firebaseparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/generalparsed"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/native.oppo-realme.txt"
          "https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/microsoft/all"
        )
        
        # Create header
        echo "# DNS Blocklist - Auto-generated" > blocklist.txt
        echo "# Last Updated: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" >> blocklist.txt
        echo "# Sources: hagezi, nickspaargaren, jmdugan" >> blocklist.txt
        echo "# ==============================================" >> blocklist.txt
        
        # Download all files in parallel and process
        for url in "${urls[@]}"; do
          curl -s "$url" | \
          # Remove comments
          sed '/^[[:space:]]*#/d' | \
          # Remove empty lines
          sed '/^[[:space:]]*$/d' | \
          # Extract domains only (remove 0.0.0.0, 127.0.0.1 prefixes, ||, etc.)
          sed -e 's/^0\.0\.0\.0[[:space:]]*//' \
              -e 's/^127\.0\.0\.1[[:space:]]*//' \
              -e 's/^||//' \
              -e 's/\^$//' \
              -e 's/^@@//' \
              -e 's/[[:space:]]*$//' \
              -e '/^[[:space:]]*$/d' \
              -e '/^[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}[[:space:]]/d'
        done | \
        # Sort, remove duplicates, and filter
        sort -u | \
        # Remove invalid entries and clean up
        grep -v '^[[:space:]]*$' | \
        grep -v '^[0-9]\{1,3\}\.' | \
        grep -v '^\.' | \
        grep -v '^/' | \
        grep -v '^\\' | \
        grep -v '^\*' | \
        grep -v '^\!' | \
        grep -v '^\[.*\]$' | \
        # Remove common non-domain patterns
        grep -E '^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$' | \
        # Remove TLD-only entries
        awk 'length($0) > 3' | \
        # Add manual domains
        cat - <(echo -e "storeimg.heytapimg.com\ntime-push-in.heytapmobile.com\nhttpdns-push.heytapmobile.com\nclient-uc.heytapmobi.com\napp-measurement.com") | \
        # Final sort and deduplication
        sort -u >> blocklist.txt
        
        echo "âœ… Created optimized blocklist.txt"
        echo "Total entries: $(wc -l < blocklist.txt)"
        
    - name: Create Alternative Formats (Optional)
      run: |
        # Create hosts format (if needed)
        awk '{print "0.0.0.0 " $0}' blocklist.txt > blocklist.hosts
        echo "# Total entries: $(wc -l < blocklist.hosts)" >> blocklist.hosts
        
        # Create compressed version with wildcards
        awk '{print "*." $0}' blocklist.txt > blocklist.wildcards
        sort -u blocklist.wildcards -o blocklist.wildcards
        echo "# Total entries: $(wc -l < blocklist.wildcards)" >> blocklist.wildcards
        
        # Create domains-only version for pi-hole/etc
        cp blocklist.txt blocklist.domains
        
    - name: Commit Changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add blocklist.txt
        git commit -m "Update blocklist: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST') - $(wc -l < blocklist.txt) entries" || echo "No changes"
        git push
