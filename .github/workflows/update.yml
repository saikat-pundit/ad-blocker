name: DNS Blocklist Updater
on:
  schedule:
    - cron: '30 6,11 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create Blocklist
      run: |
        # Create array of URLs to fetch
        urls=(
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/doh-vpn-proxy-bypass.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/tif.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/hosts/ultimate-compressed.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/popupads.txt"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/hoster.txt"
          "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/dyndns.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adguard/dns-rebind-protection.txt"
          "https://gitlab.com/hagezi/mirror/-/raw/main/dns-blocklists/adblock/social.txt"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/analyticsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/doubleclickparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/dnsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/proxiesparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/shortlinksparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fontsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/productsparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/androidparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/fiberparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/firebaseparsed"
          "https://raw.githubusercontent.com/nickspaargaren/no-google/master/categories/generalparsed"
          "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/domains/native.oppo-realme.txt"
          "https://raw.githubusercontent.com/jmdugan/blocklists/master/corporations/microsoft/all"
        )
        
        # Create header
        echo "# DNS Blocklist - Auto-generated" > blocklist.txt
        echo "# Last Updated: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST')" >> blocklist.txt
        echo "# Sources: hagezi, nickspaargaren, jmdugan" >> blocklist.txt
        echo "# Exclusions: facebook.com, all blogspot.com domains" >> blocklist.txt
        echo "# ==============================================" >> blocklist.txt
        
        # Temporary file for processing
        temp_file=$(mktemp)
        
        # Download all files and process
        for url in "${urls[@]}"; do
          echo "Downloading: $url" >&2
          curl -s --connect-timeout 30 --max-time 60 "$url" | \
          # Remove comments and empty lines
          sed -e '/^[[:space:]]*#/d' -e '/^[[:space:]]*$/d' | \
          # Extract domains only
          sed -e 's/^0\.0\.0\.0[[:space:]]*//' \
              -e 's/^127\.0\.0\.1[[:space:]]*//' \
              -e 's/^||//' \
              -e 's/\^$//' \
              -e 's/^@@//' \
              -e 's/[[:space:]]*$//'
        done >> "$temp_file"
        
        # Add manual HeyTap domains (INCLUDING WILDCARDS)
        # Using 'EOF' (with quotes) keeps * as literal characters
        cat >> "$temp_file" << 'EOF'
storeimg.heytapimg.com
time-push-in.heytapmobile.com
httpdns-push.heytapmobile.com
client-uc.heytapmobi.com
app-measurement.com
*.mtalk.google.com
alt1-mtalk.google.com
alt2-mtalk.google.com
alt3-mtalk.google.com
alt4-mtalk.google.com
alt5-mtalk.google.com
alt6-mtalk.google.com
alt7-mtalk.google.com
alt8-mtalk.google.com
mtalk.google.com
*.heytapimg.com
*.heytapmobile.com
*.heytapmobi.com
*.heytap.com
*.heytapdl.com
*.heytapdownload.com
*.app-measurement.com
*app-measurement.com
EOF
        
        # Process the combined list
        cat "$temp_file" | \
        # Remove empty lines
        grep -v '^[[:space:]]*$' | \
        # Remove IP addresses
        grep -v '^[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' | \
        # Remove lines starting with / \ ! [ ] (but keep wildcards *)
        grep -v '^[[:space:]]*/' | \
        grep -v '^[[:space:]]*\\' | \
        grep -v '^[[:space:]]*!' | \
        grep -v '^[[:space:]]*\[' | \
        grep -v '^[[:space:]]*\]' | \
        # Remove TLD-only entries
        awk 'length($0) > 3' | \
        # EXCLUDE FACEBOOK AND ALL BLOGGER DOMAINS
        grep -v '^facebook\.com$' | \
        grep -v '^.*\.facebook\.com$' | \
        grep -v '\.blogspot\.com$' | \
        # Sort and remove duplicates
        sort -u >> blocklist.txt
        
        # Clean up temp file
        rm "$temp_file"
        
        echo "âœ… Created optimized blocklist.txt"
        echo "Total entries: $(wc -l < blocklist.txt)"
        
    - name: Commit Changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add blocklist.txt
        git commit -m "Update blocklist: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S IST') - $(wc -l < blocklist.txt) entries" || echo "No changes"
        git push
